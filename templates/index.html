<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Reconocimiento Facial Flask</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='estilos/estilos.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap"
    rel="stylesheet">
</head>

<body>
  <!-- BotÃ³n de configuraciÃ³n -->
  <div class="config-button" id="config-button" title="Configurar salÃ³n">
    <span style="font-size: 30px;">âš™</span>
  </div>

  <!-- BotÃ³n de FAQ -->
  <div class="faq-button" id="faq-button" title="Ayuda y preguntas frecuentes">
    <span style="font-size: 30px;">?</span>
  </div>

  <!-- Badge mostrando salÃ³n actual -->
  <div class="salon-badge" id="salon-badge">
    <span id="salon-text">Cargando...</span>
  </div>
  

  <!-- Modal de configuraciÃ³n -->
  <div class="config-modal" id="config-modal">
    <div class="config-modal-content">
      <!-- â¬‡ï¸ BOTÃ“N CERRAR (X) -->
      <button class="btn-cerrar-modal" id="btn-cerrar-modal">âœ–</button>
      
      <!-- PASO 1: AUTENTICACIÃ“N -->
      <div id="auth-step">
        <div class="config-modal-header">
          <h2>AutenticaciÃ³n Requerida</h2>
          <p style="color: #7F7F7F; margin: 0;">Solo administradores pueden cambiar el salÃ³n</p>
        </div>

        <div class="config-modal-body">
          <input type="email" id="modal-admin-email" placeholder="Correo electrÃ³nico">
          <input type="password" id="modal-admin-password" placeholder="ContraseÃ±a">
          <div id="modal-error" class="modal-error"></div>
        </div>

        <div class="config-modal-footer">
          <button class="btn-modal-confirmar" id="btn-modal-verificar">
            Verificar
          </button>
        </div>
      </div>

      <!-- PASO 2: SELECCIÃ“N DE SALÃ“N -->
      <div id="salon-step" style="display: none;">
        <div class="config-modal-header">
          <h2>Cambiar SalÃ³n</h2>
          <p style="color: #7F7F7F; margin: 0;">Selecciona el nuevo salÃ³n</p>
        </div>

        <div class="config-modal-body">
          <select id="modal-salon-select">
            <option value="" style="color: #7F7F7F;">-- Selecciona un salÃ³n --</option>
          </select>
        </div>

        <div class="config-modal-footer">
          <button class="btn-modal-cancelar" id="btn-modal-cancelar">
            Cancelar
          </button>
          <button class="btn-modal-confirmar" id="btn-modal-confirmar">
            Confirmar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de FAQ -->
  <div class="faq-modal" id="faq-modal">
    <div class="faq-modal-content">
      <button class="btn-cerrar-modal-faq" id="btn-cerrar-faq">âœ–</button>
      
      <div class="faq-header">
        <h2>Preguntas Frecuentes</h2>
      </div>

      <div class="faq-body">
        <div class="faq-item">
          <h3>Â¿QuÃ© hacer si el sistema no me reconoce?</h3>
          <p>AsegÃºrate de estar bien iluminado, mirar directamente a la cÃ¡mara y estar a una distancia adecuada. Si el problema persiste, ingresa a clase e informa al docente del fallo en el sistema para que modifique tu asistencia.</p>
        </div>

        <div class="faq-item">
          <h3>Â¿QuÃ© hacer si no quiero dar mi consentimiento al tratamiento de datos?</h3>
          <p>El tratamiento de datos biomÃ©tricos es voluntario. Si no deseas proporcionar tu consentimiento, deberÃ¡s registrar tu asistencia hablando con el docente.</p>
        </div>

        
        <div class="faq-item">
          <h3>Â¿CÃ³mo gestiono mis datos personales y consiento al tratamiento?</h3>
          <p>Los datos de nombre, cÃ©dula y horario son brindados por la universidad; si quieres modificarlos, acÃ©rcate a los directivos de la instituciÃ³n.</p>
          <p>Si quieres gestionar tu consentimiento al tratamiento de datos biomÃ©tricos para el reconocimiento facial, haz clic en <a href="/gestion-datos" class="enlace-gestion">este enlace</a>.</p>
        </div>

        <div class="faq-item">
          <h3>Â¿QuÃ© hacer si el sistema me registrÃ³ como otra persona?</h3>
          <p>Reporta inmediatamente el error al docente para que pueda corregir el registro manualmente.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE CARGA -->
  <div class="pantalla-carga" id="pantalla-carga">
    <img src="{{ url_for('static', filename='imagenes/IA.png') }}" alt="IA" class="ia-grande">
    <div class="mensaje-carga">
      <h2>VERIFICANDO...</h2>
      <p>Comprobando cursos activos en el salÃ³n</p>
      <div class="loading-spinner"></div>
    </div>
  </div>

 <!-- PANTALLA DE ESPERA SIN CONTADOR -->
  <div class="pantalla-espera-simple" id="pantalla-espera-simple">
    <img src="{{ url_for('static', filename='imagenes/IA.png') }}" alt="IA" class="ia-grande">

    <div class="mensaje-espera">
      <h2>ESPERANDO...</h2>
      <p>Por el momento no hay ningÃºn curso activo.</p>
      <p>Â¡RegresarÃ© a registrar asistencia 5 minutos antes de que empiece tu clase!</p>
    </div>
  </div>

  <!-- PANTALLA DE ESPERA CON CONTADOR -->
  <div class="pantalla-espera-contador" id="pantalla-espera-contador">
    <img src="{{ url_for('static', filename='imagenes/IA.png') }}" alt="IA" class="ia-grande">

    <div class="mensaje-espera">
      <h2>PRÃ“XIMA CLASE</h2>
      <p>El registro de asistencia se abrirÃ¡ pronto</p>
      <div class="flex-container">
        <div class="flex-item">
          <p id="nombre-proximo-curso">Cargando...</p>
          <p id="hora-proximo-curso">Hora: --:--</p>
        </div>
        <div class="flex-item">
          <p id="tiempo-restante">--:--</p>
        </div>
      </div>
    </div>
  </div>

  <!-- PANTALLA DE RECONOCIMIENTO -->
  <div class="pantalla-reconocimiento" id="pantalla-reconocimiento">
    <div class="contenedor-principal">
      <div class="texto-bienvenida">Â¡SonrÃ­e! Te reconocerÃ©.</div>

      <div id="container">
        <video id="camara-video" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
        <div class="ia-encima">
          <img src="{{ url_for('static', filename='imagenes/IA.png') }}" alt="Cara de la IA">
        </div>
      </div>

      <!-- NUEVO: Mensaje de estado dinÃ¡mico -->
      <div id="mensaje-estado" class="mensaje-estado" style="display: none;">
        <span id="mensaje-texto"></span>
      </div>

      <a href="{{ url_for('registrar') }}">
        <button class="btn-registrar">Registrar nuevo estudiante</button>
      </a>
    </div>
  </div>

  <div class="logo">
    <img src="{{ url_for('static', filename='imagenes/logo_uni.png') }}" alt="Logo de la Universidad">
  </div>

  <script type="module">
    import { initFirebase } from "/static/firebaseCred.js";
    import { signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // Inicializar Firebase
    let auth;
    try {
      const firebaseApp = await initFirebase();
      auth = firebaseApp.auth;
    } catch (error) {
      console.error('Error inicializando Firebase:', error);
    }

   // VARIABLES GLOBALES
    const pantallaCarga = document.getElementById('pantalla-carga');
    const pantallaEsperaSimple = document.getElementById('pantalla-espera-simple');
    const pantallaEsperaContador = document.getElementById('pantalla-espera-contador');
    const pantallaReconocimiento = document.getElementById('pantalla-reconocimiento');
    const nombreProximoCurso = document.getElementById('nombre-proximo-curso');
    const horaProximoCurso = document.getElementById('hora-proximo-curso');
    const tiempoRestante = document.getElementById('tiempo-restante');

    const video = document.getElementById('camara-video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const backendUrl = '/registro';

    const configButton = document.getElementById('config-button');
    const salonBadge = document.getElementById('salon-badge');
    const salonText = document.getElementById('salon-text');
    const configModal = document.getElementById('config-modal');
    const btnCerrarModal = document.getElementById('btn-cerrar-modal');

    const authStep = document.getElementById('auth-step');
    const salonStep = document.getElementById('salon-step');
    const modalAdminEmail = document.getElementById('modal-admin-email');
    const modalAdminPassword = document.getElementById('modal-admin-password');
    const btnModalVerificar = document.getElementById('btn-modal-verificar');
    const modalError = document.getElementById('modal-error');

    const modalSalonSelect = document.getElementById('modal-salon-select');
    const btnModalConfirmar = document.getElementById('btn-modal-confirmar');
    const btnModalCancelar = document.getElementById('btn-modal-cancelar');

    let salonesDisponibles = [];
    let isAdmin = false;
    let intervaloVerificacion = null;
    let intervaloCuentaRegresiva = null;
    let modoActual = null; // 'cargando', 'espera_simple', 'espera_contador', 'reconocimiento'
    let camaraIniciada = false;

    // ============================================
    // VERIFICACIÃ“N DE CURSO ACTIVO
    // ============================================
    async function verificarCursoActivo() {
      try {
        const response = await fetch('/api/verificar_curso_activo');
        const data = await response.json();

        console.log('Estado del sistema:', data);

        if (data.curso_activo) {
          // MODO 4: HAY CURSO ACTIVO - Reconocimiento
          if (modoActual !== 'reconocimiento') {
            console.log('âœ… Activando modo RECONOCIMIENTO');
            activarModoReconocimiento();
          }
        } else if (data.proximo_curso) {
          // MODO 3: Hay curso prÃ³ximo (â‰¤5 min) - Contador
          if (modoActual !== 'espera_contador') {
            console.log('â° Activando modo ESPERA CON CONTADOR');
            activarModoEsperaContador(data.proximo_curso);
          } else {
            // Ya estamos en contador, solo actualizar
            actualizarInfoProximoCurso(data.proximo_curso);
          }
        } else {
          // MODO 2: No hay cursos prÃ³ximos - Espera simple
          if (modoActual !== 'espera_simple') {
            console.log('â¸ï¸ Activando modo ESPERA SIMPLE');
            activarModoEsperaSimple();
          }
        }
      } catch (error) {
        console.error('Error verificando curso activo:', error);
      }
    }

    function ocultarTodasPantallas() {
      pantallaCarga.classList.remove('visible');
      pantallaEsperaSimple.classList.remove('visible');
      pantallaEsperaContador.classList.remove('visible');
      pantallaReconocimiento.classList.remove('visible');
    }

    function activarModoCargando() {
      modoActual = 'cargando';
      ocultarTodasPantallas();
      pantallaCarga.classList.add('visible');
      detenerCamara();
      detenerContador();
    }

    function activarModoEsperaSimple() {
      modoActual = 'espera_simple';
      ocultarTodasPantallas();
      pantallaEsperaSimple.classList.add('visible');
      detenerCamara();
      detenerContador();
    }

    function activarModoEsperaContador(proximoCurso) {
      modoActual = 'espera_contador';
      ocultarTodasPantallas();
      pantallaEsperaContador.classList.add('visible');
      detenerCamara();
      actualizarInfoProximoCurso(proximoCurso);
      iniciarCuentaRegresiva(proximoCurso);
    }

    function activarModoReconocimiento() {
      modoActual = 'reconocimiento';
      ocultarTodasPantallas();
      pantallaReconocimiento.classList.add('visible');
      detenerContador();
      
      if (!camaraIniciada) {
        iniciarCamara();
      }
    }

    function detenerCamara() {
      if (camaraIniciada && video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(track => track.stop());
        video.srcObject = null;
        camaraIniciada = false;
        console.log('ðŸ“· CÃ¡mara detenida');
      }
    }

    function detenerContador() {
      if (intervaloCuentaRegresiva) {
        clearInterval(intervaloCuentaRegresiva);
        intervaloCuentaRegresiva = null;
      }
    }

    function actualizarInfoProximoCurso(proximoCurso) {
      if (proximoCurso) {
        nombreProximoCurso.textContent = proximoCurso.nombre_curso;
        horaProximoCurso.textContent = `Hora de inicio: ${proximoCurso.hora_inicio}`;
      }
    }

    function iniciarCuentaRegresiva(proximoCurso) {
      detenerContador();

      intervaloCuentaRegresiva = setInterval(() => {
        const ahora = new Date();
        const horaActual = ahora.getHours() * 60 + ahora.getMinutes();

        const [horaInicio, minInicio] = proximoCurso.hora_inicio.split(':').map(Number);
        const horaInicioCurso = horaInicio * 60 + minInicio;

        // El registro se abre 5 minutos ANTES
        const horaApertura = horaInicioCurso - 5;

        let minutosRestantes = horaApertura - horaActual;
        let segundosRestantes = (60 - ahora.getSeconds()) % 60;

        if (minutosRestantes < 0 || (minutosRestantes === 0 && segundosRestantes === 0)) {
          tiempoRestante.textContent = '00:00';
          detenerContador();
          verificarCursoActivo();
          return;
        }

        // Ajustar segundos
        if (segundosRestantes === 60) {
          segundosRestantes = 0;
        } else if (segundosRestantes > 0) {
          minutosRestantes -= 1;
        }

        tiempoRestante.textContent = 
          `${String(minutosRestantes).padStart(2, '0')}:${String(segundosRestantes).padStart(2, '0')}`;
      }, 1000);
    }

    // ============================================
    // GESTIÃ“N DE FAQ
    // ============================================
    const faqButton = document.getElementById('faq-button');
    const faqModal = document.getElementById('faq-modal');
    const btnCerrarFaq = document.getElementById('btn-cerrar-faq');

    faqButton.addEventListener('click', () => {
      faqModal.classList.add('active');
    });

    btnCerrarFaq.addEventListener('click', () => {
      faqModal.classList.remove('active');
    });

    faqModal.addEventListener('click', (e) => {
      if (e.target === faqModal) {
        faqModal.classList.remove('active');
      }
    });

    // ============================================
    // GESTIÃ“N DE CONFIGURACIÃ“N DE SALÃ“N
    // ============================================
    async function cargarSalonActual() {
      try {
        const response = await fetch('/api/salon_actual');
        const data = await response.json();

        if (data.success && data.salon) {
          salonText.textContent = data.salon;
          salonBadge.classList.add('visible');
        } else {
          salonText.textContent = 'No configurado';
          salonBadge.classList.add('visible');
          salonBadge.style.background = 'rgba(255, 165, 0, 0.9)';
        }
      } catch (error) {
        console.error('Error cargando salÃ³n actual:', error);
        salonText.textContent = 'Error';
        salonBadge.style.background = 'rgba(255, 0, 0, 0.9)';
      }
    }

    async function cargarListaSalones() {
      try {
        const response = await fetch('/api/salones');
        const data = await response.json();

        if (data.success && data.salones) {
          salonesDisponibles = data.salones;

          modalSalonSelect.innerHTML = '<option value="">-- Selecciona un salÃ³n --</option>';

          data.salones.forEach(salon => {
            const option = document.createElement('option');
            option.value = salon;
            option.textContent = salon;
            modalSalonSelect.appendChild(option);
          });

          console.log(`âœ” ${data.salones.length} salones cargados`);
        }
      } catch (error) {
        console.error('Error cargando salones:', error);
        modalSalonSelect.innerHTML = '<option value="">Error al cargar salones</option>';
      }
    }

    configButton.addEventListener('click', () => {
      configModal.classList.add('active');
      authStep.style.display = 'block';
      salonStep.style.display = 'none';
      modalAdminEmail.value = '';
      modalAdminPassword.value = '';
      modalError.style.display = 'none';
      isAdmin = false;
    });

    btnCerrarModal.addEventListener('click', () => {
      configModal.classList.remove('active');
    });

    async function verificarAdminModal() {
      const email = modalAdminEmail.value.trim();
      const password = modalAdminPassword.value.trim();

      if (!email || !password) {
        modalError.textContent = 'Por favor ingresa correo y contraseÃ±a';
        modalError.style.display = 'block';
        return;
      }

      btnModalVerificar.disabled = true;
      btnModalVerificar.textContent = 'Verificando...';
      modalError.style.display = 'none';

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const idTokenResult = await user.getIdTokenResult();

        if (idTokenResult.claims && idTokenResult.claims.admin === true) {
          isAdmin = true;

          if (salonesDisponibles.length === 0) {
            await cargarListaSalones();
          }

          authStep.style.display = 'none';
          salonStep.style.display = 'block';
        } else {
          throw new Error('No tienes permisos de administrador');
        }
      } catch (error) {
        let mensaje = '';
        if (error.code === 'auth/user-not-found') mensaje = 'Usuario no encontrado';
        else if (error.code === 'auth/wrong-password') mensaje = 'ContraseÃ±a incorrecta';
        else if (error.code === 'auth/invalid-email') mensaje = 'Correo invÃ¡lido';
        else mensaje = error.message;

        modalError.textContent = mensaje;
        modalError.style.display = 'block';
        btnModalVerificar.disabled = false;
        btnModalVerificar.textContent = 'Verificar';
      }
    }

    btnModalVerificar.addEventListener('click', verificarAdminModal);

    modalAdminPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') verificarAdminModal();
    });

    btnModalConfirmar.addEventListener('click', async () => {
      if (!isAdmin) {
        alert('Error de autenticaciÃ³n');
        configModal.classList.remove('active');
        return;
      }

      const nuevoSalon = modalSalonSelect.value;
      if (!nuevoSalon) {
        alert('Por favor selecciona un salÃ³n');
        return;
      }

      btnModalConfirmar.disabled = true;
      btnModalConfirmar.textContent = 'Configurando...';

      try {
        const response = await fetch('/api/configurar_salon', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ salon: nuevoSalon })
        });

        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'Error al configurar salÃ³n');

        await fetch('/api/limpiar_registros', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        btnModalConfirmar.textContent = 'Â¡Configurado!';
        btnModalConfirmar.style.background = '#275317';
        btnModalConfirmar.style.color = '#b6b6b6';
        salonText.textContent = nuevoSalon;
        salonBadge.style.background = 'rgba(0, 255, 0, 0.9)';

        configModal.classList.remove('active');

        activarModoCargando();
        await verificarCursoActivo();

      } catch (error) {
        alert('Error: ' + error.message);
        btnModalConfirmar.disabled = false;
        btnModalConfirmar.textContent = 'Confirmar';
      }
    });

    btnModalCancelar.addEventListener('click', () => {
      configModal.classList.remove('active');
    });

    configModal.addEventListener('click', (e) => {
      if (e.target === configModal) {
        configModal.classList.remove('active');
      }
    });

    // ============================================
    // RECONOCIMIENTO FACIAL
    // ============================================
    const mensajeEstado = document.getElementById('mensaje-estado');
    const mensajeTexto = document.getElementById('mensaje-texto');

    function mostrarMensaje(categoria, nombreEstudiante) {
      mensajeEstado.style.display = 'flex';
      mensajeEstado.className = 'mensaje-estado';

      switch (categoria) {
        case 'temprano':
          mensajeTexto.textContent = `Llegaste temprano Â¡Muy bien!`;
          break;
        case 'justo_a_tiempo':
          mensajeTexto.textContent = `Justo a tiempo Â¡Que puntual!`;
          break;
        case 'llego':
          mensajeTexto.textContent = `Â¡Asistencia registrada! Bienvenido.`;
          break;
        case 'tarde':
          mensajeTexto.textContent = `Â¡Intenta llegar mÃ¡s temprano!`;
          break;
        case 'error':
          mensajeTexto.textContent = 'Rostro no reconocido';
          break;
      }

      setTimeout(() => {
        mensajeEstado.style.display = 'none';
      }, 5000);
    }

    async function iniciarCamara() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        camaraIniciada = true;
        console.log('ðŸ“· CÃ¡mara iniciada');
        setInterval(enviarFotograma, 2000);
      } catch (err) {
        console.error("Error cÃ¡mara:", err);
      }
    }

    function dibujar(box, reconocido, confianza, nombre) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const [x, y, w, h] = box;
      const mirroredX = canvas.width - x - w;

      ctx.lineWidth = 3;
      ctx.strokeStyle = reconocido ? 'lime' : 'red';
      ctx.strokeRect(mirroredX, y, w, h);

      ctx.fillStyle = reconocido ? 'lime' : 'red';
      ctx.font = '20px Arial';
      ctx.fillText(
        reconocido ? `${nombre} (${confianza.toFixed(1)})` : `Desconocido (${confianza.toFixed(1)})`,
        mirroredX,
        y - 10
      );
    }

    async function enviarFotograma() {
      if (!camaraIniciada || modoActual !== 'reconocimiento') return;

      const tmp = document.createElement('canvas');
      tmp.width = video.videoWidth;
      tmp.height = video.videoHeight;
      const tmpCtx = tmp.getContext('2d');
      tmpCtx.drawImage(video, 0, 0);
      const imgBase64 = tmp.toDataURL('image/jpeg');

      try {
        const res = await fetch(backendUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: imgBase64 })
        });
        const data = await res.json();

        if (data.estado === 'reconocido') {
          dibujar(data.box, true, data.confianza, data.estudiante);

          if (data.categoria_llegada) {
            mostrarMensaje(data.categoria_llegada, data.estudiante);
          }
        } else if (data.estado === 'desconocido') {
          dibujar(data.box, false, data.confianza);
          mostrarMensaje('error', '');
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      } catch (e) {
        console.error('Error:', e);
      }
    }

    // ============================================
    // INICIALIZACIÃ“N
    // ============================================
    async function inicializar() {
      activarModoCargando();
      await cargarSalonActual();
      await verificarCursoActivo();

      intervaloVerificacion = setInterval(verificarCursoActivo, 30000);

      console.log('ðŸš€ Sistema iniciado - VerificaciÃ³n automÃ¡tica cada 30s');
    }

    inicializar();
  </script>
</body>

</html>